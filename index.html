<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Museum Art Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #1a1a1a;
            --card: #252525;
            --accent: #c9a55a;
            --text: #f0f0f0;
            --text-dim: #888;
            --danger: #e74c3c;
        }

        html {
            background: var(--bg);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        header {
            background: var(--bg);
            padding: 0.5rem 5% 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: 2px;
            color: var(--accent);
            text-transform: uppercase;
        }

        .floating-nav {
            position: fixed;
            top: 16px;
            right: 5%;
            display: flex;
            background: rgba(37, 37, 37, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 100rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 4px;
            z-index: 9999;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .floating-nav a {
            text-decoration: none;
            color: var(--text-dim);
            padding: 6px 14px;
            border-radius: 100rem;
            transition: all 0.2s;
        }

        .floating-nav a:hover {
            color: var(--text);
        }

        .floating-nav a.active {
            background: var(--accent);
            color: var(--bg);
        }

        @media (max-width: 500px) {
            h1 { font-size: 1.4rem; }
        }

        .search-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .search-bar input {
            background: #333;
            border: 1px solid #555;
            color: var(--text);
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 25px;
            width: 280px;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-bar button {
            background: var(--accent);
            color: #1a1a1a;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .search-bar button:hover {
            opacity: 0.9;
        }

        .genre-selector {
            margin: 10px 0;
        }

        .genre-select {
            background: #333;
            color: var(--text);
            border: 1px solid var(--accent);
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            min-width: 280px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23c9a55a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        .genre-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(201, 165, 90, 0.3);
        }

        .genre-select option {
            background: #333;
            color: var(--text);
            padding: 10px;
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 10px 25px;
            cursor: pointer;
            font-size: 0.85rem;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .btn:hover, .btn.active {
            background: var(--accent);
            color: #1a1a1a;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.btn-subtle {
            border-color: #555;
            color: #888;
        }

        .btn.btn-subtle:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: transparent;
        }

        .badge {
            background: var(--accent);
            color: #1a1a1a;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.75rem;
            margin-left: 8px;
        }

        .stats {
            text-align: center;
            padding: 15px;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: var(--card);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s, opacity 0.3s;
            cursor: pointer;
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .card.removing {
            opacity: 0;
            transform: scale(0.8);
        }

        .card-img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background: #333;
        }

        .card-info {
            padding: 15px;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 5px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-artist {
            color: var(--accent);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .card-meta {
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: rgba(0,0,0,0.7);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: white;
        }

        .icon-btn:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.1);
        }

        .icon-btn.favorited {
            background: var(--accent);
            color: #1a1a1a;
        }

        .dismiss-btn {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .dismiss-btn:hover {
            background: var(--danger);
        }

        .icon-btn.remove-btn:hover {
            background: var(--danger);
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 30px;
            flex-wrap: wrap;
        }

        .page-info {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .load-more-btn {
            background: var(--accent);
            color: #1a1a1a;
            border: none;
            padding: 15px 40px;
            font-size: 1rem;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .load-more-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(201, 165, 90, 0.3);
        }

        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.open {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            max-width: 1200px;
            width: 95%;
            max-height: 95vh;
            display: flex;
            gap: 30px;
            padding: 20px;
        }

        .modal-img-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .modal-info {
            width: 350px;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .modal-artist {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .modal-details {
            color: var(--text-dim);
            font-size: 0.9rem;
            line-height: 1.8;
            margin-bottom: 25px;
        }

        .modal-details strong {
            color: var(--text);
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: var(--text);
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-dim);
            grid-column: 1 / -1;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .museum-tag {
            display: inline-block;
            background: #333;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }

        @media (max-width: 900px) {
            .modal-content {
                flex-direction: column;
            }
            .modal-info {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .gallery { padding: 10px; gap: 10px; }
            .controls { gap: 8px; }
            .btn { padding: 8px 15px; font-size: 0.75rem; }
            .genre-select { min-width: 200px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <nav class="floating-nav">
        <a href="https://ericdaniel.co" target="_top">Home</a>
        <a href="https://ericdaniel.co/vibe/art-finder" target="_top" class="active">Vibe</a>
    </nav>

    <header>
        <div class="header-top">
            <h1>Art Finder</h1>
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search any keyword..." onkeypress="if(event.key==='Enter')customSearch()">
            <button onclick="customSearch()">Search</button>
        </div>
        <div class="genre-selector">
            <select class="genre-select" id="genreSelect" onchange="changeGenre()">
                <optgroup label="Movements & Styles">
                    <option value="romanticism" selected>Romanticism & Hudson River School</option>
                    <option value="impressionism">Impressionism</option>
                    <option value="post-impressionism">Post-Impressionism</option>
                    <option value="expressionism">Expressionism</option>
                    <option value="realism">Realism</option>
                    <option value="baroque">Baroque</option>
                    <option value="renaissance">Renaissance</option>
                    <option value="neoclassicism">Neoclassicism</option>
                    <option value="rococo">Rococo</option>
                    <option value="symbolism">Symbolism</option>
                    <option value="art-nouveau">Art Nouveau</option>
                    <option value="cubism">Cubism & Modern Art</option>
                    <option value="surrealism">Surrealism</option>
                    <option value="abstract">Abstract Art</option>
                </optgroup>
                <optgroup label="Subjects & Themes">
                    <option value="landscape">Landscapes</option>
                    <option value="portrait">Portraits</option>
                    <option value="still-life">Still Life</option>
                    <option value="religious">Religious & Biblical</option>
                    <option value="mythology">Mythology</option>
                    <option value="marine">Marine & Seascapes</option>
                    <option value="animals">Animals & Wildlife</option>
                    <option value="genre-scenes">Genre Scenes (Daily Life)</option>
                </optgroup>
                <optgroup label="Regional & Cultural">
                    <option value="dutch-golden">Dutch Golden Age</option>
                    <option value="japanese">Japanese Art (Ukiyo-e)</option>
                    <option value="chinese">Chinese Art</option>
                    <option value="islamic">Islamic Art</option>
                    <option value="ancient">Ancient Art</option>
                </optgroup>
            </select>
        </div>
        <p class="subtitle" id="genreSubtitle">Hudson River School & European Romanticism</p>
        <div class="controls">
            <button class="btn active" onclick="showAll()" id="allBtn">All Works</button>
            <button class="btn" onclick="showFavorites()" id="favBtn">
                Favorites <span class="badge" id="favCount">0</span>
            </button>
            <button class="btn" onclick="downloadFavorites()" id="downloadBtn" disabled>
                Download Favorites
            </button>
        </div>
    </header>

    <div class="stats" id="stats">Loading artworks...</div>

    <div class="gallery" id="gallery">
        <div class="loading">
            <div class="spinner"></div>
            <p>Searching museum collections...</p>
        </div>
    </div>

    <div class="pagination" id="pagination" style="display:none">
        <button class="load-more-btn" onclick="loadMore()" id="loadMoreBtn">Load More Artworks</button>
        <span class="page-info" id="pageInfo"></span>
    </div>

    <div class="modal" id="modal">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <div class="modal-img-container">
                <img class="modal-img" id="modalImg" src="" alt="">
            </div>
            <div class="modal-info">
                <h2 class="modal-title" id="modalTitle"></h2>
                <p class="modal-artist" id="modalArtist"></p>
                <div class="modal-details" id="modalDetails"></div>
                <div class="modal-actions">
                    <button class="btn" onclick="toggleFavoriteModal()" id="modalFavBtn">Add to Favorites</button>
                    <button class="btn" onclick="downloadCurrent()">Download Image</button>
                    <button class="btn" onclick="openSource()">View on Museum Site</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allArtworks = [];
        let favorites = JSON.parse(localStorage.getItem('artFavorites')) || [];
        let favoriteArtworks = JSON.parse(localStorage.getItem('artFavoriteData')) || {}; // Store full artwork data
        let dismissed = []; // Session only, not persisted
        let currentView = 'all';
        let currentArtwork = null;
        let isLoading = false;
        let loadedSearches = { met: 0, chicago: 0, rijks: 0, cleveland: 0, walters: 0 };
        let currentGenre = 'romanticism';

        // Genre definitions with search terms for each museum
        const genres = {
            'romanticism': {
                name: 'Romanticism & Hudson River School',
                subtitle: 'Hudson River School & European Romanticism',
                met: ['Hudson River School', 'Thomas Cole', 'Albert Bierstadt', 'Frederic Edwin Church', 'romantic landscape', 'J.M.W. Turner', 'John Constable', 'Caspar David Friedrich', 'romanticism', 'Asher Durand', 'Sanford Gifford', 'Jasper Cropsey'],
                chicago: ['romanticism', 'Hudson River School', 'romantic landscape', 'Thomas Cole', 'Bierstadt', 'Turner', 'romantic painting'],
                rijks: ['romantic', 'romantiek', 'landscape romantic', 'romantisch']
            },
            'impressionism': {
                name: 'Impressionism',
                subtitle: 'Light, color, and everyday moments',
                met: ['impressionism', 'Monet', 'Renoir', 'Degas', 'Pissarro', 'Sisley', 'impressionist', 'Manet', 'Berthe Morisot', 'Mary Cassatt'],
                chicago: ['impressionism', 'Monet', 'Renoir', 'impressionist', 'Degas', 'Caillebotte'],
                rijks: ['impressionisme', 'impressionist', 'Monet', 'impressionistisch']
            },
            'post-impressionism': {
                name: 'Post-Impressionism',
                subtitle: 'Van Gogh, Cézanne, Gauguin & beyond',
                met: ['post-impressionism', 'Van Gogh', 'Cézanne', 'Gauguin', 'Seurat', 'Toulouse-Lautrec', 'pointillism', 'Paul Signac'],
                chicago: ['post-impressionism', 'Van Gogh', 'Cézanne', 'Gauguin', 'Seurat', 'pointillism'],
                rijks: ['Van Gogh', 'post-impressionisme', 'pointillisme']
            },
            'expressionism': {
                name: 'Expressionism',
                subtitle: 'Emotional intensity and bold colors',
                met: ['expressionism', 'Kirchner', 'Kandinsky', 'Franz Marc', 'Egon Schiele', 'Edvard Munch', 'Die Brücke', 'Der Blaue Reiter'],
                chicago: ['expressionism', 'expressionist', 'Kandinsky', 'Kirchner', 'German expressionism'],
                rijks: ['expressionisme', 'expressionistisch']
            },
            'realism': {
                name: 'Realism',
                subtitle: 'Depicting life as it truly appears',
                met: ['realism', 'Courbet', 'Millet', 'Winslow Homer', 'Thomas Eakins', 'realist painting', 'Jean-François Millet'],
                chicago: ['realism', 'Courbet', 'realist', 'Winslow Homer', 'American realism'],
                rijks: ['realisme', 'realistisch']
            },
            'baroque': {
                name: 'Baroque',
                subtitle: 'Drama, grandeur, and rich detail',
                met: ['baroque', 'Rembrandt', 'Vermeer', 'Caravaggio', 'Rubens', 'Velázquez', 'baroque painting', 'chiaroscuro'],
                chicago: ['baroque', 'Rembrandt', 'Caravaggio', 'Rubens', 'Velázquez'],
                rijks: ['barok', 'Rembrandt', 'Vermeer', 'baroque', 'gouden eeuw']
            },
            'renaissance': {
                name: 'Renaissance',
                subtitle: 'Classical revival and humanist ideals',
                met: ['renaissance', 'Leonardo', 'Raphael', 'Botticelli', 'Titian', 'Michelangelo', 'Italian renaissance', 'Northern renaissance'],
                chicago: ['renaissance', 'Italian renaissance', 'Botticelli', 'Titian'],
                rijks: ['renaissance', 'italiaanse renaissance']
            },
            'neoclassicism': {
                name: 'Neoclassicism',
                subtitle: 'Greek and Roman classical revival',
                met: ['neoclassicism', 'Jacques-Louis David', 'Ingres', 'neoclassical', 'Antonio Canova', 'classical painting'],
                chicago: ['neoclassicism', 'neoclassical', 'David', 'Ingres'],
                rijks: ['neoclassicisme', 'classicisme']
            },
            'rococo': {
                name: 'Rococo',
                subtitle: 'Elegance, playfulness, and ornate beauty',
                met: ['rococo', 'Fragonard', 'Boucher', 'Watteau', 'rococo painting', 'fête galante'],
                chicago: ['rococo', 'Fragonard', 'Boucher', 'Watteau'],
                rijks: ['rococo', 'rococostijl']
            },
            'symbolism': {
                name: 'Symbolism',
                subtitle: 'Dreams, myths, and hidden meanings',
                met: ['symbolism', 'Gustave Moreau', 'Odilon Redon', 'symbolist', 'Puvis de Chavannes', 'Arnold Böcklin'],
                chicago: ['symbolism', 'symbolist', 'Redon', 'Moreau'],
                rijks: ['symbolisme', 'symbolistisch']
            },
            'art-nouveau': {
                name: 'Art Nouveau',
                subtitle: 'Organic forms and decorative elegance',
                met: ['art nouveau', 'Alphonse Mucha', 'Klimt', 'Tiffany', 'jugendstil', 'decorative arts'],
                chicago: ['art nouveau', 'Mucha', 'Klimt', 'decorative'],
                rijks: ['art nouveau', 'jugendstil', 'nieuwe kunst']
            },
            'cubism': {
                name: 'Cubism & Modern Art',
                subtitle: 'Picasso, Braque, and geometric forms',
                met: ['cubism', 'Picasso', 'Braque', 'Juan Gris', 'Fernand Léger', 'cubist', 'modern art'],
                chicago: ['cubism', 'Picasso', 'cubist', 'Braque', 'modern art'],
                rijks: ['kubisme', 'moderne kunst', 'Picasso']
            },
            'surrealism': {
                name: 'Surrealism',
                subtitle: 'Dreams, the unconscious, and the irrational',
                met: ['surrealism', 'Salvador Dalí', 'René Magritte', 'Max Ernst', 'surrealist', 'Joan Miró'],
                chicago: ['surrealism', 'Dalí', 'Magritte', 'surrealist', 'Ernst'],
                rijks: ['surrealisme', 'surrealistisch']
            },
            'abstract': {
                name: 'Abstract Art',
                subtitle: 'Form, color, and non-representational expression',
                met: ['abstract', 'abstract expressionism', 'Mondrian', 'Rothko', 'Pollock', 'Kandinsky abstract', 'color field'],
                chicago: ['abstract', 'abstract expressionism', 'Mondrian', 'Rothko', 'Pollock'],
                rijks: ['abstract', 'abstracte kunst', 'Mondriaan']
            },
            'landscape': {
                name: 'Landscapes',
                subtitle: 'Nature, scenery, and the great outdoors',
                met: ['landscape painting', 'landscape', 'mountain landscape', 'forest landscape', 'river landscape', 'sunset landscape', 'pastoral'],
                chicago: ['landscape', 'landscape painting', 'nature painting', 'scenery'],
                rijks: ['landschap', 'landscape', 'natuurgezicht']
            },
            'portrait': {
                name: 'Portraits',
                subtitle: 'Capturing the human likeness',
                met: ['portrait', 'portrait painting', 'self portrait', 'portraiture', 'figure painting'],
                chicago: ['portrait', 'portraiture', 'self portrait', 'figure'],
                rijks: ['portret', 'portrait', 'zelfportret']
            },
            'still-life': {
                name: 'Still Life',
                subtitle: 'Objects, flowers, and arrangements',
                met: ['still life', 'flower painting', 'vanitas', 'fruit painting', 'nature morte'],
                chicago: ['still life', 'flowers', 'vanitas', 'fruit'],
                rijks: ['stilleven', 'bloemen', 'vanitas', 'still life']
            },
            'religious': {
                name: 'Religious & Biblical',
                subtitle: 'Sacred stories and spiritual themes',
                met: ['religious painting', 'biblical', 'madonna', 'crucifixion', 'saints', 'altar', 'christian art'],
                chicago: ['religious', 'biblical', 'madonna', 'saints', 'christian'],
                rijks: ['religieus', 'bijbels', 'madonna', 'heiligen']
            },
            'mythology': {
                name: 'Mythology',
                subtitle: 'Gods, heroes, and ancient legends',
                met: ['mythology', 'mythological', 'Greek mythology', 'Venus', 'Apollo', 'classical mythology'],
                chicago: ['mythology', 'mythological', 'classical', 'Greek gods'],
                rijks: ['mythologie', 'mythologisch', 'goden']
            },
            'marine': {
                name: 'Marine & Seascapes',
                subtitle: 'The sea, ships, and coastal scenes',
                met: ['marine painting', 'seascape', 'ships', 'naval', 'maritime', 'ocean painting'],
                chicago: ['marine', 'seascape', 'ships', 'ocean', 'coastal'],
                rijks: ['zeegezicht', 'marine', 'schepen', 'zee']
            },
            'animals': {
                name: 'Animals & Wildlife',
                subtitle: 'Creatures great and small',
                met: ['animal painting', 'horses', 'dogs', 'wildlife', 'birds', 'hunting scene'],
                chicago: ['animal', 'horses', 'dogs', 'wildlife', 'birds'],
                rijks: ['dieren', 'paarden', 'honden', 'vogels']
            },
            'genre-scenes': {
                name: 'Genre Scenes',
                subtitle: 'Everyday life and domestic moments',
                met: ['genre painting', 'genre scene', 'domestic scene', 'tavern', 'peasant', 'daily life'],
                chicago: ['genre', 'daily life', 'domestic', 'peasant'],
                rijks: ['genrestuk', 'dagelijks leven', 'interieur']
            },
            'dutch-golden': {
                name: 'Dutch Golden Age',
                subtitle: '17th century Dutch masters',
                met: ['Dutch Golden Age', 'Dutch painting', 'Rembrandt', 'Vermeer', 'Frans Hals', 'Dutch masters'],
                chicago: ['Dutch Golden Age', 'Dutch painting', 'Rembrandt', 'Vermeer'],
                rijks: ['gouden eeuw', 'hollandse meesters', '17e eeuw', 'Rembrandt', 'Vermeer']
            },
            'japanese': {
                name: 'Japanese Art',
                subtitle: 'Ukiyo-e prints and traditional painting',
                met: ['ukiyo-e', 'Japanese print', 'Hokusai', 'Hiroshige', 'Japanese painting', 'woodblock'],
                chicago: ['ukiyo-e', 'Japanese', 'Hokusai', 'Hiroshige', 'woodblock'],
                rijks: ['japans', 'ukiyo-e', 'Hokusai', 'prentkunst japan']
            },
            'chinese': {
                name: 'Chinese Art',
                subtitle: 'Landscapes, calligraphy, and tradition',
                met: ['Chinese painting', 'Chinese landscape', 'Chinese scroll', 'Chinese art', 'ink painting China'],
                chicago: ['Chinese painting', 'Chinese art', 'Chinese scroll'],
                rijks: ['chinees', 'chinese kunst']
            },
            'islamic': {
                name: 'Islamic Art',
                subtitle: 'Geometric patterns and illumination',
                met: ['Islamic art', 'Persian miniature', 'Islamic calligraphy', 'Mughal', 'arabesque'],
                chicago: ['Islamic', 'Persian', 'Mughal', 'Middle Eastern'],
                rijks: ['islamitisch', 'perzisch', 'arabisch']
            },
            'ancient': {
                name: 'Ancient Art',
                subtitle: 'Egyptian, Greek, and Roman antiquities',
                met: ['ancient Egyptian', 'ancient Greek', 'ancient Roman', 'antiquity', 'classical sculpture'],
                chicago: ['ancient', 'Egyptian', 'Greek antiquity', 'Roman'],
                rijks: ['oudheid', 'egyptisch', 'grieks', 'romeins']
            }
        };

        function getCurrentSearchTerms() {
            return genres[currentGenre] || genres['romanticism'];
        }

        // Filter for paintings/drawings/prints - exclude coins, pottery, sculpture, furniture, etc.
        function isPainting(medium, objectName) {
            const text = ((medium || '') + ' ' + (objectName || '')).toLowerCase();
            const exclude = ['coin', 'ceramic', 'pottery', 'vase', 'bowl', 'plate', 'sculpture', 'statue', 'furniture', 'textile', 'tapestry', 'armor', 'weapon', 'jewelry', 'silver', 'gold object', 'bronze object', 'glass', 'porcelain', 'stoneware', 'earthenware', 'medal', 'seal', 'vessel', 'jar', 'cup', 'ewer', 'flask', 'bottle', 'figurine'];
            if (exclude.some(e => text.includes(e))) return false;
            return true;
        }

        async function fetchMet(startIndex = 0, count = 5) {
            const results = [];
            const terms = getCurrentSearchTerms().met;
            const searches = terms.slice(startIndex, startIndex + count);

            for (const term of searches) {
                try {
                    const searchRes = await fetch(`https://collectionapi.metmuseum.org/public/collection/v1/search?q=${encodeURIComponent(term)}&hasImages=true&isPublicDomain=true`);
                    const searchData = await searchRes.json();

                    if (searchData.objectIDs) {
                        const ids = searchData.objectIDs.slice(0, 20);
                        const details = await Promise.all(
                            ids.map(id =>
                                fetch(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${id}`)
                                    .then(r => r.json())
                                    .catch(() => null)
                            )
                        );

                        for (const obj of details) {
                            if (obj && obj.primaryImage && obj.isPublicDomain && isPainting(obj.medium, obj.objectName)) {
                                results.push({
                                    id: `met-${obj.objectID}`,
                                    title: obj.title || 'Untitled',
                                    artist: obj.artistDisplayName || 'Unknown Artist',
                                    artistUrl: obj.artistWikidata_URL || null,
                                    date: obj.objectDate || '',
                                    medium: obj.medium || '',
                                    dimensions: obj.dimensions || '',
                                    museum: 'The Met',
                                    imageUrl: obj.primaryImage,
                                    thumbUrl: obj.primaryImageSmall || obj.primaryImage,
                                    sourceUrl: obj.objectURL,
                                    department: obj.department || ''
                                });
                            }
                        }
                    }
                } catch (e) {
                    console.log('Met search error:', e);
                }
            }
            return results;
        }

        async function fetchChicago(startIndex = 0, count = 5) {
            const results = [];
            const terms = getCurrentSearchTerms().chicago;
            const searches = terms.slice(startIndex, startIndex + count);

            for (const term of searches) {
                try {
                    const res = await fetch(`https://api.artic.edu/api/v1/artworks/search?q=${encodeURIComponent(term)}&query[term][is_public_domain]=true&fields=id,title,artist_display,artist_id,date_display,medium_display,dimensions,image_id,artwork_type_title&limit=25`);
                    const data = await res.json();

                    if (data.data) {
                        for (const art of data.data) {
                            if (art.image_id && isPainting(art.medium_display, art.artwork_type_title)) {
                                results.push({
                                    id: `chicago-${art.id}`,
                                    title: art.title || 'Untitled',
                                    artist: art.artist_display || 'Unknown Artist',
                                    artistUrl: art.artist_id ? `https://www.artic.edu/artists/${art.artist_id}` : null,
                                    date: art.date_display || '',
                                    medium: art.medium_display || '',
                                    dimensions: art.dimensions || '',
                                    museum: 'Art Institute of Chicago',
                                    imageUrl: `https://www.artic.edu/iiif/2/${art.image_id}/full/1200,/0/default.jpg`,
                                    thumbUrl: `https://www.artic.edu/iiif/2/${art.image_id}/full/400,/0/default.jpg`,
                                    sourceUrl: `https://www.artic.edu/artworks/${art.id}`
                                });
                            }
                        }
                    }
                } catch (e) {
                    console.log('Chicago search error:', e);
                }
            }
            return results;
        }

        async function fetchRijks(startIndex = 0, count = 3) {
            const results = [];
            const apiKey = '0fiuZFh4';
            const terms = getCurrentSearchTerms().rijks;
            const searches = terms.slice(startIndex, startIndex + count);

            for (const term of searches) {
                try {
                    const res = await fetch(`https://www.rijksmuseum.nl/api/en/collection?key=${apiKey}&q=${encodeURIComponent(term)}&imgonly=true&ps=25`);
                    const data = await res.json();

                    if (data.artObjects) {
                        for (const art of data.artObjects) {
                            if (art.webImage && art.webImage.url) {
                                results.push({
                                    id: `rijks-${art.objectNumber}`,
                                    title: art.title || 'Untitled',
                                    artist: art.principalOrFirstMaker || 'Unknown Artist',
                                    artistUrl: null,
                                    date: '',
                                    medium: '',
                                    dimensions: '',
                                    museum: 'Rijksmuseum',
                                    imageUrl: art.webImage.url,
                                    thumbUrl: art.webImage.url.replace('=s0', '=s400'),
                                    sourceUrl: art.links?.web || `https://www.rijksmuseum.nl/en/collection/${art.objectNumber}`
                                });
                            }
                        }
                    }
                } catch (e) {
                    console.log('Rijks search error:', e);
                }
            }
            return results;
        }

        async function fetchCleveland(startIndex = 0, count = 3) {
            const results = [];
            const terms = getCurrentSearchTerms().cleveland || getCurrentSearchTerms().met.slice(0, 5);
            const searches = terms.slice(startIndex, startIndex + count);

            for (const term of searches) {
                try {
                    const res = await fetch(`https://openaccess-api.clevelandart.org/api/artworks?q=${encodeURIComponent(term)}&has_image=1&limit=20`);
                    const data = await res.json();
                    if (data.data) {
                        for (const art of data.data) {
                            if (art.images?.web && isPainting(art.technique, art.type)) {
                                results.push({
                                    id: `cleveland-${art.id}`,
                                    title: art.title || 'Untitled',
                                    artist: art.creators?.map(c => c.description).join(', ') || 'Unknown Artist',
                                    artistUrl: null,
                                    date: art.creation_date || '',
                                    medium: art.technique || '',
                                    dimensions: art.dimensions || '',
                                    museum: 'Cleveland Museum of Art',
                                    imageUrl: art.images.web.url,
                                    thumbUrl: art.images.web.url,
                                    sourceUrl: art.url || `https://www.clevelandart.org/art/${art.id}`
                                });
                            }
                        }
                    }
                } catch (e) { console.log('Cleveland error:', e); }
            }
            return results;
        }

        async function fetchWalters(startIndex = 0, count = 3) {
            const results = [];
            const terms = getCurrentSearchTerms().walters || getCurrentSearchTerms().met.slice(0, 5);
            const searches = terms.slice(startIndex, startIndex + count);

            for (const term of searches) {
                try {
                    const res = await fetch(`https://api.thewalters.org/v1/objects?keyword=${encodeURIComponent(term)}&pageSize=20`);
                    const data = await res.json();
                    if (data.Items) {
                        for (const art of data.Items) {
                            if (art.PrimaryImage?.Raw && isPainting(art.Medium, art.Classification)) {
                                results.push({
                                    id: `walters-${art.ObjectID}`,
                                    title: art.Title || 'Untitled',
                                    artist: art.Creator || 'Unknown Artist',
                                    artistUrl: null,
                                    date: art.DateText || '',
                                    medium: art.Medium || '',
                                    dimensions: art.Dimensions || '',
                                    museum: 'Walters Art Museum',
                                    imageUrl: art.PrimaryImage.Raw,
                                    thumbUrl: art.PrimaryImage.Small || art.PrimaryImage.Raw,
                                    sourceUrl: art.ResourceURL || `https://art.thewalters.org/detail/${art.ObjectID}`
                                });
                            }
                        }
                    }
                } catch (e) { console.log('Walters error:', e); }
            }
            return results;
        }

        function dedupeArtworks(artworks, existingArtworks = []) {
            const seen = new Set();
            const existingIds = new Set(existingArtworks.map(a => a.id));
            return artworks.filter(art => {
                if (existingIds.has(art.id)) return false;
                const key = `${art.title}-${art.artist}`.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        async function loadInitialArtworks() {
            document.getElementById('gallery').innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching museum collections...</p></div>';

            try {
                const [metResults, chicagoResults, rijksResults, clevelandResults, waltersResults] = await Promise.all([
                    fetchMet(0, 4),
                    fetchChicago(0, 4),
                    fetchRijks(0, 3),
                    fetchCleveland(0, 3),
                    fetchWalters(0, 3)
                ]);

                loadedSearches = { met: 4, chicago: 4, rijks: 3, cleveland: 3, walters: 3 };

                allArtworks = dedupeArtworks([
                    ...metResults,
                    ...chicagoResults,
                    ...rijksResults,
                    ...clevelandResults,
                    ...waltersResults
                ]);

                allArtworks.sort(() => Math.random() - 0.5);

                syncFavoriteData();
                updateStats();
                renderGallery();
                updatePagination();
            } catch (e) {
                console.error('Error loading artworks:', e);
                document.getElementById('gallery').innerHTML = '<div class="error">Error loading artworks. Please refresh to try again.</div>';
            }
        }

        let customSearchTerm = null;

        async function customSearch() {
            const input = document.getElementById('searchInput');
            const term = input.value.trim();
            if (!term) return;

            customSearchTerm = term;
            document.getElementById('genreSubtitle').textContent = `Search results for "${term}"`;
            document.getElementById('genreSelect').value = '';

            allArtworks = [];
            dismissed = [];
            loadedSearches = { met: 0, chicago: 0, rijks: 0, cleveland: 0, walters: 0 };
            currentView = 'all';
            setActiveButton('all');

            document.getElementById('gallery').innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching museums...</p></div>';

            try {
                const [metRes, chicagoRes, rijksRes, clevelandRes, waltersRes] = await Promise.all([
                    fetchCustom('met', term),
                    fetchCustom('chicago', term),
                    fetchCustom('rijks', term),
                    fetchCustom('cleveland', term),
                    fetchCustom('walters', term)
                ]);

                allArtworks = dedupeArtworks([...metRes, ...chicagoRes, ...rijksRes, ...clevelandRes, ...waltersRes]);
                allArtworks.sort(() => Math.random() - 0.5);

                updateStats();
                renderGallery();
                document.getElementById('pagination').style.display = 'none';
            } catch (e) {
                console.error('Search error:', e);
            }
        }

        async function fetchCustom(museum, term) {
            try {
                if (museum === 'met') {
                    const res = await fetch(`https://collectionapi.metmuseum.org/public/collection/v1/search?q=${encodeURIComponent(term)}&hasImages=true&isPublicDomain=true`);
                    const data = await res.json();
                    if (!data.objectIDs) return [];
                    const ids = data.objectIDs.slice(0, 25);
                    const details = await Promise.all(ids.map(id => fetch(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${id}`).then(r => r.json()).catch(() => null)));
                    return details.filter(obj => obj?.primaryImage && obj.isPublicDomain && isPainting(obj.medium, obj.objectName)).map(obj => ({
                        id: `met-${obj.objectID}`, title: obj.title || 'Untitled', artist: obj.artistDisplayName || 'Unknown Artist',
                        artistUrl: obj.artistWikidata_URL || null,
                        date: obj.objectDate || '', medium: obj.medium || '', dimensions: obj.dimensions || '', museum: 'The Met',
                        imageUrl: obj.primaryImage, thumbUrl: obj.primaryImageSmall || obj.primaryImage, sourceUrl: obj.objectURL
                    }));
                } else if (museum === 'chicago') {
                    const res = await fetch(`https://api.artic.edu/api/v1/artworks/search?q=${encodeURIComponent(term)}&query[term][is_public_domain]=true&fields=id,title,artist_display,artist_id,date_display,medium_display,dimensions,image_id,artwork_type_title&limit=25`);
                    const data = await res.json();
                    return (data.data || []).filter(a => a.image_id && isPainting(a.medium_display, a.artwork_type_title)).map(a => ({
                        id: `chicago-${a.id}`, title: a.title || 'Untitled', artist: a.artist_display || 'Unknown Artist',
                        artistUrl: a.artist_id ? `https://www.artic.edu/artists/${a.artist_id}` : null,
                        date: a.date_display || '', medium: a.medium_display || '', dimensions: a.dimensions || '', museum: 'Art Institute of Chicago',
                        imageUrl: `https://www.artic.edu/iiif/2/${a.image_id}/full/1200,/0/default.jpg`, thumbUrl: `https://www.artic.edu/iiif/2/${a.image_id}/full/400,/0/default.jpg`, sourceUrl: `https://www.artic.edu/artworks/${a.id}`
                    }));
                } else if (museum === 'rijks') {
                    const res = await fetch(`https://www.rijksmuseum.nl/api/en/collection?key=0fiuZFh4&q=${encodeURIComponent(term)}&imgonly=true&ps=25`);
                    const data = await res.json();
                    return (data.artObjects || []).filter(a => a.webImage?.url).map(a => ({
                        id: `rijks-${a.objectNumber}`, title: a.title || 'Untitled', artist: a.principalOrFirstMaker || 'Unknown Artist',
                        artistUrl: null,
                        date: '', medium: '', dimensions: '', museum: 'Rijksmuseum', imageUrl: a.webImage.url, thumbUrl: a.webImage.url.replace('=s0', '=s400'), sourceUrl: a.links?.web || `https://www.rijksmuseum.nl/en/collection/${a.objectNumber}`
                    }));
                } else if (museum === 'cleveland') {
                    const res = await fetch(`https://openaccess-api.clevelandart.org/api/artworks?q=${encodeURIComponent(term)}&has_image=1&limit=25`);
                    const data = await res.json();
                    return (data.data || []).filter(a => a.images?.web && isPainting(a.technique, a.type)).map(a => ({
                        id: `cleveland-${a.id}`, title: a.title || 'Untitled', artist: a.creators?.map(c => c.description).join(', ') || 'Unknown Artist',
                        artistUrl: null,
                        date: a.creation_date || '', medium: a.technique || '', dimensions: a.dimensions || '', museum: 'Cleveland Museum of Art',
                        imageUrl: a.images.web.url, thumbUrl: a.images.web.url, sourceUrl: `https://www.clevelandart.org/art/${a.id}`
                    }));
                } else if (museum === 'walters') {
                    const res = await fetch(`https://api.thewalters.org/v1/objects?keyword=${encodeURIComponent(term)}&pageSize=25`);
                    const data = await res.json();
                    return (data.Items || []).filter(a => a.PrimaryImage?.Raw && isPainting(a.Medium, a.Classification)).map(a => ({
                        id: `walters-${a.ObjectID}`, title: a.Title || 'Untitled', artist: a.Creator || 'Unknown Artist',
                        artistUrl: null,
                        date: a.DateText || '', medium: a.Medium || '', dimensions: a.Dimensions || '', museum: 'Walters Art Museum',
                        imageUrl: a.PrimaryImage.Raw, thumbUrl: a.PrimaryImage.Small || a.PrimaryImage.Raw, sourceUrl: `https://art.thewalters.org/detail/${a.ObjectID}`
                    }));
                }
            } catch (e) { console.log(`${museum} search error:`, e); }
            return [];
        }

        function changeGenre() {
            const select = document.getElementById('genreSelect');
            currentGenre = select.value;
            if (!currentGenre) return;

            customSearchTerm = null;
            document.getElementById('searchInput').value = '';
            const genre = genres[currentGenre];

            document.getElementById('genreSubtitle').textContent = genre.subtitle;

            // Reset and reload
            allArtworks = [];
            loadedSearches = { met: 0, chicago: 0, rijks: 0, cleveland: 0, walters: 0 };
            currentView = 'all';
            setActiveButton('all');

            loadInitialArtworks();
        }

        async function loadMore() {
            if (isLoading) return;
            isLoading = true;

            const btn = document.getElementById('loadMoreBtn');
            btn.textContent = 'Loading...';
            btn.disabled = true;

            try {
                const [metResults, chicagoResults, rijksResults, clevelandResults, waltersResults] = await Promise.all([
                    fetchMet(loadedSearches.met, 3),
                    fetchChicago(loadedSearches.chicago, 3),
                    fetchRijks(loadedSearches.rijks, 2),
                    fetchCleveland(loadedSearches.cleveland, 2),
                    fetchWalters(loadedSearches.walters, 2)
                ]);

                loadedSearches.met += 3;
                loadedSearches.chicago += 3;
                loadedSearches.rijks += 2;
                loadedSearches.cleveland += 2;
                loadedSearches.walters += 2;

                const newArtworks = dedupeArtworks([
                    ...metResults,
                    ...chicagoResults,
                    ...rijksResults,
                    ...clevelandResults,
                    ...waltersResults
                ], allArtworks);

                newArtworks.sort(() => Math.random() - 0.5);
                allArtworks = [...allArtworks, ...newArtworks];

                updateStats();
                renderGallery();
                updatePagination();

            } catch (e) {
                console.error('Error loading more:', e);
            }

            btn.textContent = 'Load More Artworks';
            btn.disabled = false;
            isLoading = false;
        }

        function getVisibleArtworks() {
            if (currentView === 'favorites') {
                return favorites
                    .filter(id => !dismissed.includes(id))
                    .map(id => favoriteArtworks[id] || allArtworks.find(a => a.id === id))
                    .filter(Boolean);
            }
            return allArtworks.filter(a => !dismissed.includes(a.id));
        }

        function updateStats() {
            const artworks = getVisibleArtworks();
            const museums = {};
            artworks.forEach(a => {
                museums[a.museum] = (museums[a.museum] || 0) + 1;
            });

            const statsText = Object.entries(museums)
                .map(([m, c]) => `${m}: ${c}`)
                .join(' · ');

            const viewLabel = currentView === 'favorites' ? 'favorite ' : currentView === 'hidden' ? 'hidden ' : '';
            document.getElementById('stats').textContent =
                `${artworks.length} ${viewLabel}artworks${statsText ? ' · ' + statsText : ''}`;
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const terms = getCurrentSearchTerms();

            const hasMoreSearches = loadedSearches.met < terms.met.length ||
                                    loadedSearches.chicago < terms.chicago.length ||
                                    loadedSearches.rijks < terms.rijks.length;

            if (currentView === 'all' && hasMoreSearches) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `Showing ${getVisibleArtworks().length} artworks`;
            } else {
                pagination.style.display = 'none';
            }
        }

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const artworks = getVisibleArtworks();

            if (artworks.length === 0) {
                const message = currentView === 'favorites'
                    ? 'No favorites yet. Click the star on artworks you love!'
                    : 'Loading...';
                gallery.innerHTML = `<div class="loading"><p>${message}</p></div>`;
                return;
            }

            gallery.innerHTML = artworks.map(art => `
                <div class="card" id="card-${art.id}" onclick="openModal('${art.id}')">
                    <img class="card-img" src="${art.thumbUrl}" alt="${art.title}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22>No Image</text></svg>'">
                    <button class="icon-btn dismiss-btn" onclick="event.stopPropagation(); dismissArt('${art.id}')" title="Dismiss">✕</button>
                    <div class="card-actions">
                        <button class="icon-btn ${isFavorite(art.id) ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite('${art.id}')">
                            ${isFavorite(art.id) ? '★' : '☆'}
                        </button>
                        <button class="icon-btn" onclick="event.stopPropagation(); downloadArt('${art.id}')" title="Download">↓</button>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${art.title}</div>
                        <div class="card-artist">${art.artist}</div>
                        <div class="card-meta">
                            <span class="museum-tag">${art.museum}</span>
                            ${art.date ? ` · ${art.date}` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function dismissArt(id) {
            const card = document.getElementById(`card-${id}`);
            if (card) card.classList.add('removing');
            setTimeout(() => {
                dismissed.push(id);
                updateStats();
                renderGallery();
            }, 300);
        }

        function isFavorite(id) {
            return favorites.includes(id);
        }

        function toggleFavorite(id) {
            if (favorites.includes(id)) {
                favorites = favorites.filter(f => f !== id);
                // Remove from stored data
                delete favoriteArtworks[id];
            } else {
                favorites.push(id);
                // Store the full artwork data so it persists across genres
                const art = allArtworks.find(a => a.id === id);
                if (art) {
                    favoriteArtworks[id] = art;
                }
            }
            localStorage.setItem('artFavorites', JSON.stringify(favorites));
            localStorage.setItem('artFavoriteData', JSON.stringify(favoriteArtworks));
            updateCounts();
            renderGallery();
            updateStats();
        }

        function updateCounts() {
            document.getElementById('favCount').textContent = favorites.length;
            document.getElementById('downloadBtn').disabled = favorites.length === 0;
        }

        function setActiveButton(view) {
            document.querySelectorAll('.controls .btn').forEach(b => b.classList.remove('active'));
            if (view === 'all') document.getElementById('allBtn').classList.add('active');
            else if (view === 'favorites') document.getElementById('favBtn').classList.add('active');
        }

        function showAll() {
            currentView = 'all';
            setActiveButton('all');
            updateStats();
            renderGallery();
            updatePagination();
        }

        function showFavorites() {
            currentView = 'favorites';
            setActiveButton('favorites');
            updateStats();
            renderGallery();
            updatePagination();
        }

        function openModal(id) {
            currentArtwork = allArtworks.find(a => a.id === id) || favoriteArtworks[id];
            if (!currentArtwork) return;

            document.getElementById('modalImg').src = currentArtwork.imageUrl;
            document.getElementById('modalTitle').textContent = currentArtwork.title;

            const artistEl = document.getElementById('modalArtist');
            const artistName = currentArtwork.artist;
            const artistUrl = currentArtwork.artistUrl || (artistName && artistName !== 'Unknown Artist' ? `https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(artistName)}` : null);
            if (artistUrl) {
                artistEl.innerHTML = `<a href="${artistUrl}" target="_blank" style="color: inherit; text-decoration: underline; text-underline-offset: 3px;">${artistName}</a>`;
            } else {
                artistEl.textContent = artistName;
            }
            document.getElementById('modalDetails').innerHTML = `
                ${currentArtwork.date ? `<p><strong>Date:</strong> ${currentArtwork.date}</p>` : ''}
                ${currentArtwork.medium ? `<p><strong>Medium:</strong> ${currentArtwork.medium}</p>` : ''}
                ${currentArtwork.dimensions ? `<p><strong>Dimensions:</strong> ${currentArtwork.dimensions}</p>` : ''}
                <p><strong>Collection:</strong> ${currentArtwork.museum}</p>
            `;

            updateModalButtons();
            document.getElementById('modal').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('open');
            document.body.style.overflow = '';
            currentArtwork = null;
        }

        function updateModalButtons() {
            if (!currentArtwork) return;
            document.getElementById('modalFavBtn').textContent = isFavorite(currentArtwork.id) ? 'Remove from Favorites' : 'Add to Favorites';
        }

        function toggleFavoriteModal() {
            if (!currentArtwork) return;
            toggleFavorite(currentArtwork.id);
            updateModalButtons();
        }

        function downloadArt(id) {
            const art = allArtworks.find(a => a.id === id) || favoriteArtworks[id];
            if (!art) return;

            const link = document.createElement('a');
            link.href = art.imageUrl;
            link.download = `${art.artist} - ${art.title}`.replace(/[^a-z0-9]/gi, '_') + '.jpg';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadCurrent() {
            if (currentArtwork) {
                downloadArt(currentArtwork.id);
            }
        }

        function openSource() {
            if (currentArtwork && currentArtwork.sourceUrl) {
                window.open(currentArtwork.sourceUrl, '_blank');
            }
        }

        async function downloadFavorites() {
            const favArts = favorites
                .map(id => favoriteArtworks[id] || allArtworks.find(a => a.id === id))
                .filter(Boolean);
            if (favArts.length === 0) return;

            alert(`Downloading ${favArts.length} artworks. They will open in new tabs - please allow popups if prompted.`);

            for (const art of favArts) {
                downloadArt(art.id);
                await new Promise(r => setTimeout(r, 500));
            }
        }

        // Event listeners
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Sync any favorites in current artworks to stored data
        function syncFavoriteData() {
            allArtworks.forEach(art => {
                if (favorites.includes(art.id) && !favoriteArtworks[art.id]) {
                    favoriteArtworks[art.id] = art;
                }
            });
            localStorage.setItem('artFavoriteData', JSON.stringify(favoriteArtworks));
        }

        // Fetch missing favorites directly by ID
        async function fetchMissingFavorites() {
            const missing = favorites.filter(id => !favoriteArtworks[id]);
            if (missing.length === 0) return;

            for (const id of missing) {
                try {
                    if (id.startsWith('met-')) {
                        const objId = id.replace('met-', '');
                        const res = await fetch(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${objId}`);
                        const obj = await res.json();
                        if (obj && obj.primaryImage) {
                            favoriteArtworks[id] = {
                                id, title: obj.title || 'Untitled', artist: obj.artistDisplayName || 'Unknown',
                                artistUrl: obj.artistWikidata_URL || null,
                                date: obj.objectDate || '', medium: obj.medium || '', dimensions: obj.dimensions || '',
                                museum: 'The Met', imageUrl: obj.primaryImage, thumbUrl: obj.primaryImageSmall || obj.primaryImage,
                                sourceUrl: obj.objectURL
                            };
                        }
                    } else if (id.startsWith('chicago-')) {
                        const artId = id.replace('chicago-', '');
                        const res = await fetch(`https://api.artic.edu/api/v1/artworks/${artId}?fields=id,title,artist_display,date_display,medium_display,dimensions,image_id`);
                        const data = await res.json();
                        if (data.data && data.data.image_id) {
                            const art = data.data;
                            favoriteArtworks[id] = {
                                id, title: art.title || 'Untitled', artist: art.artist_display || 'Unknown',
                                date: art.date_display || '', medium: art.medium_display || '', dimensions: art.dimensions || '',
                                museum: 'Art Institute of Chicago',
                                imageUrl: `https://www.artic.edu/iiif/2/${art.image_id}/full/1200,/0/default.jpg`,
                                thumbUrl: `https://www.artic.edu/iiif/2/${art.image_id}/full/400,/0/default.jpg`,
                                sourceUrl: `https://www.artic.edu/artworks/${artId}`
                            };
                        }
                    } else if (id.startsWith('rijks-')) {
                        const objNum = id.replace('rijks-', '');
                        const res = await fetch(`https://www.rijksmuseum.nl/api/en/collection/${objNum}?key=0fiuZFh4`);
                        const data = await res.json();
                        if (data.artObject && data.artObject.webImage) {
                            const art = data.artObject;
                            favoriteArtworks[id] = {
                                id, title: art.title || 'Untitled', artist: art.principalOrFirstMaker || 'Unknown',
                                date: '', medium: '', dimensions: '', museum: 'Rijksmuseum',
                                imageUrl: art.webImage.url, thumbUrl: art.webImage.url.replace('=s0', '=s400'),
                                sourceUrl: art.links?.web || `https://www.rijksmuseum.nl/en/collection/${objNum}`
                            };
                        }
                    } else if (id.startsWith('cleveland-')) {
                        const artId = id.replace('cleveland-', '');
                        const res = await fetch(`https://openaccess-api.clevelandart.org/api/artworks/${artId}`);
                        const data = await res.json();
                        if (data.data?.images?.web) {
                            const art = data.data;
                            favoriteArtworks[id] = {
                                id, title: art.title || 'Untitled', artist: art.creators?.map(c => c.description).join(', ') || 'Unknown',
                                date: art.creation_date || '', medium: art.technique || '', dimensions: art.dimensions || '',
                                museum: 'Cleveland Museum of Art', imageUrl: art.images.web.url, thumbUrl: art.images.web.url,
                                sourceUrl: `https://www.clevelandart.org/art/${artId}`
                            };
                        }
                    } else if (id.startsWith('walters-')) {
                        const objId = id.replace('walters-', '');
                        const res = await fetch(`https://api.thewalters.org/v1/objects/${objId}`);
                        const data = await res.json();
                        if (data.Data?.PrimaryImage?.Raw) {
                            const art = data.Data;
                            favoriteArtworks[id] = {
                                id, title: art.Title || 'Untitled', artist: art.Creator || 'Unknown',
                                date: art.DateText || '', medium: art.Medium || '', dimensions: art.Dimensions || '',
                                museum: 'Walters Art Museum', imageUrl: art.PrimaryImage.Raw, thumbUrl: art.PrimaryImage.Small || art.PrimaryImage.Raw,
                                sourceUrl: `https://art.thewalters.org/detail/${objId}`
                            };
                        }
                    }
                } catch (e) { console.log('Failed to fetch favorite:', id); }
            }
            localStorage.setItem('artFavoriteData', JSON.stringify(favoriteArtworks));
            if (currentView === 'favorites') { updateStats(); renderGallery(); }
        }

        // Initialize
        updateCounts();
        loadInitialArtworks();
        fetchMissingFavorites();
    </script>
    <script>
        (function() {
            var nav = document.querySelector('.floating-nav');
            var h1 = document.querySelector('h1');
            if (!nav || !h1) return;
            function align() {
                var r = h1.getBoundingClientRect();
                nav.style.top = (r.top + r.height / 2) + 'px';
                nav.style.transform = 'translateY(-50%)';
            }
            align();
            window.addEventListener('resize', align);
        })();
    </script>
</body>
</html>
